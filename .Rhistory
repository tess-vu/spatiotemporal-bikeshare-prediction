cat("Updated Model 2 MAE:", round(mae_update, 4), "\n")
cat("Improvement:", round(mae_model2 - mae_update, 4), "trips per hour\n")
cat("Percent Improvement:", round(100 * (mae_model2 - mae_update) / mae_model2, 2), "%\n")
#| message: false
#| warning: false
# Poisson assumes integer counts and handles overdispersion better.
poisson_model <- glm(
trips ~ as.factor(hour) + dow_simple + temp + precip +
# Add temporal trend variable.
days_since_oct1 + is_too_cold +
# Add time slot markers.
is_evening + is_mid_day + is_morning +
lag_1hr + lag_3hr + lag_1day +
# Add interaction between cold and time.
# Cold might matter more as winter progresses.
(is_too_cold * days_since_oct1) +
# Add interaction between cold and morning, evening, mid-day.
(is_too_cold * is_evening) +
(is_too_cold * is_mid_day) +
(is_too_cold * is_morning) +
# Individuals may be more likely to take evening transit.
(pct_public_commute : is_evening) +
# Non-white individuals will generally be later.
(lag_30min : pct_poc) + (lag_1hr : pct_poc) + (lag_1hr30min : pct_poc) +
(lag_2hr : pct_poc) + (lag_2hr30min : pct_poc) +
(lag_3hr : pct_poc) + (lag_1day : pct_poc),
data = train_clean,
# Use log link for Poisson family.
family = poisson(link = "log")
)
summary(poisson_model)
# Generate predictions on response scale.
test_clean$pred_poisson <- predict(poisson_model, newdata = test_clean, type = "response")
# Calculate MAE for Poisson model.
mae_poisson <- mean(abs(test_clean$trips - test_clean$pred_poisson), na.rm = TRUE)
# Compare Poisson to OLS.
cat("OLS Updated Model 2 MAE:", round(mae_update, 4), "\n")
cat("Poisson Model MAE:", round(mae_poisson, 4), "\n")
# Note: Assuming your 'update_model' (OLS) and 'poisson_model' are still in memory.
# --- OLS MODEL OVERFITTING TEST ---
test_clean$pred_ols_best <- predict(update_model, newdata = test_clean)
train_clean$pred_ols_train <- predict(update_model, newdata = train_clean) # Predict on TRAIN data
mae_test_ols <- mean(abs(test_clean$trips - test_clean$pred_ols_best), na.rm = TRUE)
mae_train_ols <- mean(abs(train_clean$trips - train_clean$pred_ols_train), na.rm = TRUE)
cat("--- OLS Overfitting Check ---\n")
cat("MAE (Test Set, Out-of-Sample):", round(mae_test_ols, 4), "\n")
cat("MAE (Train Set, In-Sample): ", round(mae_train_ols, 4), "\n")
cat("Difference (Train - Test): ", round(mae_train_ols - mae_test_ols, 4), "\n\n")
# --- POISSON MODEL OVERFITTING TEST ---
test_clean$pred_poisson_best <- predict(poisson_model, newdata = test_clean, type = "response")
train_clean$pred_poisson_train <- predict(poisson_model, newdata = train_clean, type = "response")
mae_test_poisson <- mean(abs(test_clean$trips - test_clean$pred_poisson_best), na.rm = TRUE)
mae_train_poisson <- mean(abs(train_clean$trips - train_clean$pred_poisson_train), na.rm = TRUE)
cat("--- Poisson Overfitting Check ---\n")
cat("MAE (Test Set, Out-of-Sample):", round(mae_test_poisson, 4), "\n")
cat("MAE (Train Set, In-Sample): ", round(mae_train_poisson, 4), "\n")
cat("Difference (Train - Test): ", round(mae_train_poisson - mae_test_poisson, 4), "\n")
# Check OLS model.
# Predict test data.
test_clean$pred_ols_best <- predict(update_model, newdata = test_clean)
# Predict train data.
train_clean$pred_ols_train <- predict(update_model, newdata = train_clean)
mae_test_ols <- mean(abs(test_clean$trips - test_clean$pred_ols_best), na.rm = TRUE)
mae_train_ols <- mean(abs(train_clean$trips - train_clean$pred_ols_train), na.rm = TRUE)
cat("OLS MAE (Test Set, Out-of-Sample):", round(mae_test_ols, 4), "\n")
cat("OLS MAE (Train Set, In-Sample): ", round(mae_train_ols, 4), "\n")
cat("OLS Difference (Train - Test): ", round(mae_train_ols - mae_test_ols, 4), "\n\n")
# Check Poisson model.
# Predict test data.
test_clean$pred_poisson_best <- predict(poisson_model, newdata = test_clean, type = "response")
# Predict train data.
train_clean$pred_poisson_train <- predict(poisson_model, newdata = train_clean, type = "response")
mae_test_poisson <- mean(abs(test_clean$trips - test_clean$pred_poisson_best), na.rm = TRUE)
mae_train_poisson <- mean(abs(train_clean$trips - train_clean$pred_poisson_train), na.rm = TRUE)
cat("Poisson MAE (Test Set, Out-of-Sample):", round(mae_test_poisson, 4), "\n")
cat("Poisson MAE (Train Set, In-Sample): ", round(mae_train_poisson, 4), "\n")
cat("Poisson Difference (Train - Test): ", round(mae_train_poisson - mae_test_poisson, 4), "\n")
#| message: false
#| warning: false
# Check OLS model.
# Predict test data.
test_clean$pred_ols_best <- predict(update_model, newdata = test_clean)
# Predict train data.
train_clean$pred_ols_train <- predict(update_model, newdata = train_clean)
mae_test_ols <- mean(abs(test_clean$trips - test_clean$pred_ols_best), na.rm = TRUE)
mae_train_ols <- mean(abs(train_clean$trips - train_clean$pred_ols_train), na.rm = TRUE)
cat("OLS MAE (Test Set, Out-of-Sample):", round(mae_test_ols, 4), "\n")
cat("OLS MAE (Train Set, In-Sample): ", round(mae_train_ols, 4), "\n")
cat("OLS Difference (Train - Test): ", round(mae_train_ols - mae_test_ols, 4), "\n\n")
# Check Poisson model.
# Predict test data.
test_clean$pred_poisson_best <- predict(poisson_model, newdata = test_clean, type = "response")
# Predict train data.
train_clean$pred_poisson_train <- predict(poisson_model, newdata = train_clean, type = "response")
mae_test_poisson <- mean(abs(test_clean$trips - test_clean$pred_poisson_best), na.rm = TRUE)
mae_train_poisson <- mean(abs(train_clean$trips - train_clean$pred_poisson_train), na.rm = TRUE)
cat("Poisson MAE (Test Set, Out-of-Sample):", round(mae_test_poisson, 4), "\n")
cat("Poisson MAE (Train Set, In-Sample): ", round(mae_train_poisson, 4), "\n")
cat("Poisson Difference (Train - Test): ", round(mae_train_poisson - mae_test_poisson, 4), "\n")
#| fig-dpi: 300
#| fig-height: 10
#| fig-width: 10
# Calculate station-level improvement.
station_improvements <- test_clean %>%
group_by(start_station_id, start_lat, start_lon) %>%
summarize(
# MAE for original Model 2.
mae_model2 = mean(abs(trips - pred2), na.rm = TRUE),
# MAE for updated model.
mae_update = mean(abs(trips - pred_update), na.rm = TRUE),
# Calculate improvement (positive = better).
improvement = mae_model2 - mae_update,
.groups = "drop"
)
# Create map showing improvement by station.
improvement_map <- ggplot() +
# Plot census tracts as background.
geom_sf(data = philly_census, fill = "#4c6e52", color = "#f5f4f0", linewidth = 0.5) +
# Plot stations colored by improvement.
geom_point(
data = station_improvements,
aes(x = start_lon, y = start_lat, color = improvement, size = abs(improvement)),
alpha = 0.8
) +
# Diverging color scale.
scale_color_gradient2(
low = "#0889bc", mid = "#fef7d7", high = "#e83b2e",
midpoint = 0,
name = "MAE Change"
)+
# Order legend items.
guides(
size = guide_legend(order = 1),
color = guide_colorbar(order = 2)
) +
labs(
title = "Model Improvement by Indego Station",
subtitle = "Philadelphia, PA",
caption = "Positive values indicate better predictions with new features.",
size = "Absolute Improvement"
) +
theme_map() +
theme(
# Stack legend items vertically.
legend.box = "vertical"
)
improvement_map
#| message: false
#| warning: false
#| fig-dpi: 300
#| fig-height: 18
#| fig-width: 12
station_census_lookup$pct_non_yt <- (1 - station_census_lookup$pct_white)
# Calculate percent non-white for analysis.
station_census_lookup$pct_non_yt <- (1 - station_census_lookup$pct_white)
# Join demographics to improvement data.
improvement_demo <- station_improvements %>%
left_join(
# Get demographic variables.
station_census_lookup %>%
select(start_station_id, med_inc, pct_public_commute, pct_non_yt),
by = "start_station_id"
) %>%
left_join(
# Get average demand from error analysis.
station_errors_q4 %>%
select(start_station_id, avg_demand),
by = "start_station_id"
) %>%
# Keep only stations with census data.
filter(!is.na(med_inc))
# Create scatter plot of improvement vs race.
mae_poc_improvement_plot <- ggplot(improvement_demo, aes(x = pct_non_yt, y = improvement)) +
# Size points by average demand.
geom_point(aes(size = avg_demand), alpha = 0.5, color = "#EF4269") +
# Horizontal line at zero improvement.
geom_hline(yintercept = 0, linetype = "dashed", color = "#4269EF", linewidth = 1) +
# Trend line with confidence band.
geom_smooth(method = "lm", se = TRUE, color = "#2d2a26", linetype = "longdash", linewidth = 1) +
# Format x-axis as percentage.
scale_x_continuous(labels = scales::percent) +
labs(
title = "Model Improvement by Station",
subtitle = "% Non-White Population",
x = "% Non-White",
y = "MAE Improvement (Trips per 30-Min)",
size = "Average Demand"
) +
theme_plot()
# Create scatter plot of improvement vs income.
mae_inc_improvement_plot <- ggplot(improvement_demo, aes(x = med_inc, y = improvement)) +
geom_point(aes(size = avg_demand), alpha = 0.5, color = "#EF4269") +
geom_hline(yintercept = 0, linetype = "dashed", color = "#4269EF", linewidth = 1) +
geom_smooth(method = "lm", se = TRUE, color = "#2d2a26", linetype = "longdash", linewidth = 1) +
scale_x_continuous(labels = scales::dollar) +
labs(
title = "Model Improvement by Station",
subtitle = "Median Income",
x = "Median Income",
y = "MAE Improvement (Trips per 30-Min)",
size = "Average Demand"
) +
theme_plot()
mae_pub_improvement_plot <- ggplot(improvement_demo, aes(x = pct_public_commute, y = improvement)) +
geom_point(aes(size = avg_demand), alpha = 0.5, color = "#EF4269") +
geom_hline(yintercept = 0, linetype = "dashed", color = "#4269EF", linewidth = 1) +
geom_smooth(method = "lm", se = TRUE, color = "#2d2a26", linetype = "longdash", linewidth = 1) +
scale_x_continuous(labels = scales::percent) +
labs(
title = "Model Improvement by Station",
subtitle = "% Public Transit Commuters",
caption = "Points above the dashed line show improvement (MAE decrease).\nChange in MAE (Old MAE - New MAE) vs. Median Income",
x = "Median Income",
y = "MAE Improvement (Trips per 30-Min)",
size = "Average Demand"
) +
theme_plot()
# Stack vertically.
mae_poc_improvement_plot / mae_inc_improvement_plot / mae_pub_improvement_plot
#| fig-height: 8
#| fig-width: 12
#| fig-dpi: 300
# Calculate final error based on updated model prediction (pred_update).
test_q4_error_final <- test_clean %>%
mutate(
error_final = trips - pred_update,
# Create numeric 0-47 index for plot.
time_slot_numeric = hour(interval30) * 2 + minute(interval30) / 30
)
# Calculate bias based on 30-min time.
temporal_bias_final <- test_q4_error_final %>%
group_by(time_slot_numeric, is_weekend) %>%
summarize(
mean_error = mean(error_final, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(day_type = ifelse(is_weekend, "Weekend", "Weekday"))
# Bias line plot.
bias_plot <- ggplot(temporal_bias_final, aes(x = time_slot_numeric, y = mean_error, color = day_type)) +
# Add reference line at zero.
geom_hline(yintercept = 0, linetype = "dashed", color = "#f48f33", linewidth = 1) +
# Line with points.
geom_line(linewidth = 1.5) +
geom_point(size = 3) +
scale_color_manual(values = c("Weekday" = "#08519c", "Weekend" = "#6baed6")) +
scale_x_continuous(breaks = seq(0, 48, by = 4), labels = seq(0, 24, by = 2)) +
labs(
title = "Prediction Bias by Hour and Day Type",
subtitle = "2024 Q4 Test Set",
caption = "Positive values mean the model under-predicts (demand > prediction).\nMean Error (Actual Trips - Predicted Trips)",
x = "Hour",
y = "Mean Error (Trips per 30-Min)",
color = "Day Type"
) +
theme_plot()
bias_plot
#| message: false
#| warning: false
#| fig-dpi: 300
#| fig-height: 8
#| fig-width: 10
# Calculate residuals for updated model.
test_clean <- test_clean %>%
mutate(residual = trips - pred_update)
# Scatter plot of residuals vs temperature.
temp_residuals_plot <- ggplot(test_clean, aes(x = temp, y = residual)) +
# Plot with high transparency to show density.
geom_point(alpha = 0.1, color = "#EF4269") +
# Reference line at zero residual.
geom_hline(yintercept = 0, linetype = "dashed", color = "#4269EF", linewidth = 1) +
# LOESS smooth to show non-linear pattern.
geom_smooth(method = "loess", color = "purple", se = TRUE, linewidth = 1) +
labs(
title = "Model Residuals vs. Temperature",
subtitle = "Updated OLS Model (2024 Q4 Test Set)",
caption = "Pink curve is the average bias across temperature.",
x = "Temperature (Â°F)",
y = "Residual (Actual Trips - Predicted Trips)"
) +
theme_plot()
temp_residuals_plot
# Filter improvement data for stations where improvement is negative.
worsened_stations <- improvement_demo %>%
filter(improvement < 0) %>%
# Sort by magnitude of negative improvement.
arrange(improvement) %>%
select(
start_station_id,
Improvement_MAE = improvement,
Avg_Demand = avg_demand,
Median_Income = med_inc,
Pct_Non_White = pct_non_yt,
Pct_Public_Transit = pct_public_commute
)
# Kable.
worsened_stations_kable <- worsened_stations %>%
mutate(
# Formatting.
Improvement_MAE = round(Improvement_MAE, 4),
Avg_Demand = round(Avg_Demand, 2),
Median_Income = scales::dollar(Median_Income),
Pct_Non_White = scales::percent(Pct_Non_White, accuracy = 1),
Pct_Public_Transit = scales::percent(Pct_Public_Transit, accuracy = 1)
) %>%
kable(
caption = "Updated Model: Stations Where Feature Engineering Worsened MAE (Negative Improvement)",
col.names = c(
"Station ID", "MAE Change", "Avg Demand", "Median Income",
"% Non-White", "% Public Transit"
)
) %>%
kable_styling(
bootstrap_options = c("striped", "hover", "condensed"),
full_width = FALSE
)
worsened_stations_kable
# Filter improvement data for stations where improvement is negative.
worse_stations <- improvement_demo %>%
filter(improvement < 0) %>%
# Sort by magnitude of negative improvement.
arrange(improvement) %>%
select(
start_station_id,
improvement_mae = improvement,
avg_demand = avg_demand,
med_inc = med_inc,
pct_poc = pct_poc,
pct_public_commute = pct_public_commute
)
# Filter improvement data for stations where improvement is negative.
worse_stations <- improvement_demo %>%
filter(improvement < 0) %>%
# Sort by magnitude of negative improvement.
arrange(improvement) %>%
select(
start_station_id,
improvement_mae = improvement,
avg_demand = avg_demand,
med_inc = med_inc,
pct_poc = pct_non_yt,
pct_public_commute = pct_public_commute
)
# Kable.
worse_stations_kable <- worse_stations %>%
mutate(
# Formatting.
improvement_mae = round(improvement_mae, 4),
avg_demand = round(avg_demand, 2),
med_inc = scales::dollar(med_inc),
pct_poc = scales::percent(pct_poc, accuracy = 1),
pct_public_commute = scales::percent(pct_public_commute, accuracy = 1)
) %>%
kable(
caption = "Updated Model: Stations Where Feature Engineering Worsened MAE",
col.names = c(
"Station ID", "MAE Change", "Average Demand", "Median Income",
"% Non-White", "% Public Transit"
)
) %>%
kable_styling(
bootstrap_options = c("striped", "hover", "condensed"),
full_width = FALSE
)
worse_stations_kable
# Filter improvement data for stations where improvement is negative.
worse_stations <- improvement_demo %>%
filter(improvement <= 0) %>%
# Sort by magnitude of negative improvement.
arrange(improvement) %>%
select(
start_station_id,
improvement_mae = improvement,
avg_demand = avg_demand,
med_inc = med_inc,
pct_poc = pct_non_yt,
pct_public_commute = pct_public_commute
)
# Kable.
worse_stations_kable <- worse_stations %>%
mutate(
# Formatting.
improvement_mae = round(improvement_mae, 4),
avg_demand = round(avg_demand, 2),
med_inc = scales::dollar(med_inc),
pct_poc = scales::percent(pct_poc, accuracy = 1),
pct_public_commute = scales::percent(pct_public_commute, accuracy = 1)
) %>%
kable(
caption = "Updated Model: Stations Where Feature Engineering Worsened MAE",
col.names = c(
"Station ID", "MAE Change", "Average Demand", "Median Income",
"% Non-White", "% Public Transit"
)
) %>%
kable_styling(
bootstrap_options = c("striped", "hover", "condensed"),
full_width = FALSE
)
worse_stations_kable
# Create a filtered data frame containing only stations where MAE increased.
worsened_stations_map_data <- station_improvements %>%
filter(improvement < 0)
# Map showing the location and magnitude of negative model improvement.
worsened_map <- ggplot() +
# Plot census tracts as background.
geom_sf(data = philly_census, fill = "#4c6e52", color = "#f5f4f0", linewidth = 0.5) +
# Plot the stations with negative improvement.
geom_point(
data = worsened_stations_map_data,
aes(x = start_lon, y = start_lat,
# Color by the negative improvement value.
color = improvement,
# Size by the absolute magnitude of the error increase.
size = abs(improvement)),
alpha = 0.9
) +
# Use a color scale that highlights the degree of failure (negative values).
scale_color_gradient(
low = "#e83b2e", # Deep red for slightly worse
high = "#990000", # Darkest red for significantly worse
name = "MAE Increase (Trips/30-Min)"
) +
guides(
size = guide_legend(order = 1),
color = guide_colorbar(order = 2)
) +
labs(
title = "Model Failure Analysis: Stations with Worsened Predictions",
subtitle = "Points show where the new features caused MAE to increase (Improvement < 0).",
caption = "Size indicates the magnitude of the MAE increase.",
size = "Magnitude of Error Increase"
) +
theme_map() +
theme(legend.box = "vertical")
worsened_map
```{r map-worsened-stations}
#| fig-dpi: 300
#| fig-height: 10
#| fig-width: 10
# Create a filtered data frame containing only stations where MAE increased.
worsened_stations_map_data <- station_improvements %>%
filter(improvement < 0)
# Map showing the location and magnitude of negative model improvement.
worsened_map <- ggplot() +
# Plot census tracts as background.
geom_sf(data = philly_census, fill = "#4c6e52", color = "#f5f4f0", linewidth = 0.5) +
# Plot the stations with negative improvement.
geom_point(
data = worsened_stations_map_data,
aes(x = start_lon, y = start_lat,
# Color by the negative improvement value.
color = improvement,
# Size by the absolute magnitude of the error increase.
size = abs(improvement)),
alpha = 0.9
) +
# Use a color scale that highlights the degree of failure (negative values).
scale_color_gradient(
low = "#e83b2e", # Deep red for slightly worse
high = "#990000", # Darkest red for significantly worse
name = "MAE Increase (Trips/30-Min)"
) +
guides(
size = guide_legend(order = 1),
color = guide_colorbar(order = 2)
) +
labs(
title = "Model Failure Analysis: Stations with Worsened Predictions",
subtitle = "Points show where the new features caused MAE to increase (Improvement < 0).",
caption = "Size indicates the magnitude of the MAE increase.",
size = "Magnitude of Error Increase"
) +
theme_map() +
theme(legend.box = "vertical")
worsened_map
#| fig-dpi: 300
#| fig-height: 10
#| fig-width: 10
# Map to see where stations worsened.
worsened_stations_map_data <- station_improvements %>%
filter(improvement < 0)
worsened_map <- ggplot() +
# Census tracts.
geom_sf(data = philly_census, fill = "#4c6e52", color = "#f5f4f0", linewidth = 0.5) +
# Stations with negative improvement.
geom_point(
data = worsened_stations_map_data,
aes(x = start_lon, y = start_lat,
# Color by the negative improvement.
color = improvement,
# Size by the absolute error increase.
size = abs(improvement)),
alpha = 0.9
) +
scale_color_gradient(
low = "#e83b2e",
high = "#990000",
name = "MAE Increase (Trips per 30-Min)"
) +
guides(
size = guide_legend(order = 1),
color = guide_colorbar(order = 2)
) +
labs(
title = "Indego Stations with Worsened Predictions",
subtitle = "Philadelphia, PA",
caption = "Points show where updated model caused MAE to increase.\nSize indicates the magnitude of the MAE increase.",
size = "Absolute Error Increase"
) +
theme_map() +
theme(legend.box = "vertical")
worsened_map
